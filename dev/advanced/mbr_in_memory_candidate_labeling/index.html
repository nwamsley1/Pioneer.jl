<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>- · Pioneer.jl</title><meta name="title" content="- · Pioneer.jl"/><meta property="og:title" content="- · Pioneer.jl"/><meta property="twitter:title" content="- · Pioneer.jl"/><meta name="description" content="Documentation for Pioneer.jl."/><meta property="og:description" content="Documentation for Pioneer.jl."/><meta property="twitter:description" content="Documentation for Pioneer.jl."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">Pioneer.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">User Guide</span><ul><li><a class="tocitem" href="../../user_guide/installation/">Installation Guide</a></li><li><a class="tocitem" href="../../user_guide/quickstart/">Quick Start Tutorial</a></li><li><a class="tocitem" href="../../user_guide/parameters/">Parameter Configuration</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>-</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>-</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/nwamsley1/Pioneer.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/nwamsley1/Pioneer.jl/blob/develop/docs/src/advanced/mbr_in_memory_candidate_labeling.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><p><strong>In‑Memory MBR Candidate Labeling — Bug Analysis and Fix Proposal</strong></p><p>This note explains why the in‑memory path is labeling far too many rows as match‑between‑runs (MBR) transfer candidates and how to correct it. The focus is on the in‑memory scorer in <code>percolatorSortOf.jl</code> and how it differs from the out‑of‑memory path that uses the correct logic.</p><p><strong>Where Candidates Are Labeled (In‑Memory)</strong></p><ul><li>File: <code>src/utils/ML/percolatorSortOf.jl</code></li><li>Function: <code>sort_of_percolator_in_memory!</code></li><li>Location: near the end of the function, after cross‑validation models produce final probabilities and just before the MBR features and final write‑back.</li></ul><p>Current code (abridged, as present in this branch):</p><pre><code class="language-julia hljs"># Determine which precursors failed the q-value cutoff prior to MBR
qvals_prev = Vector{Float32}(undef, length(nonMBR_estimates))
get_qvalues!(nonMBR_estimates, psms.target, qvals_prev)
pass_mask = (nonMBR_estimates .&lt;= max_q_value_lightgbm_rescore)
prob_thresh = any(pass_mask) ? minimum(nonMBR_estimates[pass_mask]) : typemax(Float32)

# Label as transfer candidates only those failing the q-value cutoff but
# whose best matched pair surpassed the passing probability threshold.
psms[!, :MBR_transfer_candidate] .= .!pass_mask .&amp;
                                    (psms.MBR_max_pair_prob .&gt;= prob_thresh)

# Use the final MBR probabilities for all precursors
psms[!, :prob] = MBR_estimates</code></pre><p>Note: <code>nonMBR_estimates</code> are probabilities (higher=better). <code>max_q_value_lightgbm_rescore</code> is a q‑value threshold (≈0.01) — a different scale.</p><p><strong>What’s Wrong (Scale Mismatch)</strong></p><ul><li><code>pass_mask = (nonMBR_estimates .&lt;= max_q_value_lightgbm_rescore)</code> compares probabilities to a q‑value threshold. Since true positives have large probabilities (e.g., 0.8, 0.9), the condition <code>p ≤ 0.01</code> is almost never true.<ul><li>Consequence: <code>pass_mask</code> is mostly false; <code>.!pass_mask</code> becomes “almost everyone”.</li></ul></li><li><code>prob_thresh = minimum(nonMBR_estimates[pass_mask])</code> is taken over a tiny set (often empty). If any are present, they tend to be extremely small (≈0), so the condition <code>MBR_max_pair_prob ≥ prob_thresh</code> is trivially satisfied by most rows.</li><li>Net effect: <code>MBR_transfer_candidate</code> is set to true for the vast majority of rows, which matches your observation:</li></ul><pre><code class="nohighlight hljs">FTR probability threshold: 0.8703515
Num passing candidate transfers: 1811822 out of 1949436</code></pre><p>This happens because the candidate set (where <code>MBR_transfer_candidate=true</code>) includes almost every row, forcing the FTR threshold τ high to keep the empirical ratio below α.</p><p><strong>Correct Intent (Reference Implementation)</strong></p><ul><li>The out‑of‑memory path uses the correct logic inside <code>update_mbr_probs!</code> (same file):</li></ul><pre><code class="language-julia hljs">function update_mbr_probs!(df::AbstractDataFrame, probs::AbstractVector{Float32}, qval_thresh::Float32)
    prev_qvals = similar(df.prob)
    get_qvalues!(df.prob, df.target, prev_qvals)   # compute q-values
    pass_mask = (prev_qvals .&lt;= qval_thresh) .&amp; df.target
    prob_thresh = any(pass_mask) ? minimum(df.prob[pass_mask]) : typemax(Float32)
    df[!, :MBR_transfer_candidate] = (prev_qvals .&gt; qval_thresh) .&amp;   # use q-values
                                     (df.MBR_max_pair_prob .&gt;= prob_thresh)
    df[!, :prob] = probs
    return df
end</code></pre><ul><li>Two key differences from the in‑memory code above:<ol><li><code>pass_mask</code> is computed with q‑values <code>prev_qvals</code>, not with probabilities.</li><li><code>prob_thresh</code> is derived from the probabilities of the passing set (as intended), but the passing set is defined by <code>qval_thresh</code>, not a probability threshold.</li></ol></li></ul><p><strong>Impact of the Bug</strong></p><ul><li>Candidate set is massively inflated in the in‑memory path, causing:<ul><li>Very high τ even at α = 0.01.</li><li>Large number of “candidate transfers” reported, which is misleading and slows down filtering.</li><li>Downstream clamping affects almost all rows, reducing the discriminative power of MBR.</li></ul></li></ul><p><strong>Minimal Fix (In‑Memory Path)</strong></p><p>Replace the probability‑based <code>pass_mask</code> with a q‑value‑based mask (as in <code>update_mbr_probs!</code>). Proposed snippet drop‑in for <code>sort_of_percolator_in_memory!</code>:</p><pre><code class="language-julia hljs"># 1) Compute q-values of non-MBR predictions
qvals_prev = Vector{Float32}(undef, length(nonMBR_estimates))
get_qvalues!(nonMBR_estimates, psms.target, qvals_prev)

# 2) Build pass/fail by q-value threshold
pass_mask = (qvals_prev .&lt;= max_q_value_lightgbm_rescore) .&amp; psms.target
prob_thresh = any(pass_mask) ? minimum(nonMBR_estimates[pass_mask]) : typemax(Float32)

# 3) Label transfer candidates: failed q-value but paired to a strong donor
psms[!, :MBR_transfer_candidate] .= (qvals_prev .&gt; max_q_value_lightgbm_rescore) .&amp;
                                    (psms.MBR_max_pair_prob .&gt;= prob_thresh)</code></pre><p>This aligns the in‑memory behavior with the out‑of‑memory <code>update_mbr_probs!</code> and ensures the candidate set is limited to plausible transfers.</p><p><strong>Verification Steps</strong></p><ul><li>Add a short diagnostic around labeling (in‑memory):<ul><li>Count of <code>pass_mask</code>, <code>candidate_count = sum(MBR_transfer_candidate)</code>, and <code>prob_thresh</code>.</li><li>Sanity: candidate<em>count should be a minority of all rows; `prob</em>thresh` should be a realistic boundary (e.g., near the minimum probability among passing targets).</li></ul></li></ul><p><strong>Summary</strong></p><ul><li>The in‑memory path mistakenly compares probabilities to a q‑value threshold, inflating <code>MBR_transfer_candidate</code>.</li><li>The out‑of‑memory path uses the correct q‑value based mask.</li><li>Switching the in‑memory logic to use q‑values (as shown above) restores consistency and reduces the candidate set, leading to reasonable τ at α=0.01.</li></ul></article><nav class="docs-footer"><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.14.1 on <span class="colophon-date" title="Thursday 25 September 2025 18:10">Thursday 25 September 2025</span>. Using Julia version 1.11.7.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
