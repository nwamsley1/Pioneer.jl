name: Build & Release Windows

on:
  push:
    branches:
      - main
      - develop
    tags:
      - 'v*.*.*'
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v1.2.3)'
        required: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  build:
    name: Build & Package Windows
    runs-on: windows-latest
    env:
      JULIA_NUM_THREADS: auto
    outputs:
      version: ${{ steps.get_version.outputs.VERSION }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64
            identifier: windows-x64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine VERSION
        id: get_version
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ github.event.inputs.tag }}" ]]; then
            echo "VERSION=${{ github.event.inputs.tag }}" >> "$GITHUB_OUTPUT"
          elif [[ "$GITHUB_REF" == refs/tags/* ]]; then
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"
          else
            echo "VERSION=v0.0.0" >> "$GITHUB_OUTPUT"
          fi

      - name: Setup Julia
        uses: julia-actions/setup-julia@v2
        with:
          version: '1.11'
          arch: ${{ matrix.arch }}

      - name: Cache Julia packages
        uses: actions/cache@v3
        with:
          path: |
            C:\Users\runneradmin\.julia\registries
            C:\Users\runneradmin\.julia\packages
          key: julia-windows-${{ matrix.identifier }}-${{ hashFiles('**/Project.toml','**/Manifest.toml') }}
          restore-keys: julia-windows-${{ matrix.identifier }}-

      - name: Install dependencies
        shell: bash
        run: |
          julia --project=. -e 'using Pkg; Pkg.add("PackageCompiler"); Pkg.instantiate()'

      - name: Precompile data (cache & download)
        uses: ./.github/actions/precompile-data
        with:
          cache-key: precompile-data-v1

      - name: Compile application
        shell: bash
        run: |
          julia --project=. -e '
            using PackageCompiler;
            create_app(
              ".",
              "build/Pioneer_${{ matrix.identifier }}/Applications/Pioneer/",
              incremental=false,
              force=true,
              executables=[
                "GetSearchParams"=>"main_GetSearchParams",
                "GetBuildLibParams"=>"main_GetBuildLibParams",
                "GetParseSpecLibParams"=>"main_GetParseSpecLibParams",
                "ParseSpecLib"=>"main_ParseSpecLib",
                "BuildSpecLib"=>"main_BuildSpecLib",
                "SearchDIA"=>"main_SearchDIA",
                "convertMzML"=>"main_convertMzML"
              ],
              precompile_execution_file="src/build/snoop.jl"
            );
          '

      - name: Download PioneerConverter
        shell: pwsh
        run: |
          $dir = "converter"
          New-Item -ItemType Directory -Force -Path $dir | Out-Null
          $pattern = "win-x64"
          $json = Invoke-WebRequest -Uri https://api.github.com/repos/nwamsley1/PioneerConverter/releases/latest |
                  Select-Object -ExpandProperty Content | ConvertFrom-Json
          $asset = ($json.assets | Where-Object { $_.name -like "*$pattern*.zip" } | Select-Object -First 1).name
          if (-not $asset) { throw "No asset found matching $pattern" }
          Invoke-WebRequest -Uri "https://github.com/nwamsley1/PioneerConverter/releases/latest/download/$asset" -OutFile converter.zip
          Expand-Archive -Path converter.zip -DestinationPath $dir
          $subdir = Get-ChildItem -Path $dir -Directory | Select-Object -First 1
          Copy-Item "$($subdir.FullName)\bin\*" "build\Pioneer_${{ matrix.identifier }}\Applications\Pioneer\bin\" -Recurse
          New-Item -ItemType Directory -Force -Path "build\Pioneer_${{ matrix.identifier }}\Applications\Pioneer\lib" | Out-Null
          Copy-Item "$($subdir.FullName)\lib\*" "build\Pioneer_${{ matrix.identifier }}\Applications\Pioneer\lib\" -Recurse

      - name: Add wrapper scripts
        shell: pwsh
        run: |
          Copy-Item src\build\CLI\pioneer.bat build\Pioneer_${{ matrix.identifier }}/Applications/Pioneer/

      - name: Package Windows MSI
        shell: pwsh
        run: |
          $pioneerRoot = "build\Pioneer_${{ matrix.identifier }}\Applications\Pioneer"
          $dataDir = "$pioneerRoot\data"
          New-Item -ItemType Directory -Force -Path $dataDir | Out-Null
          Copy-Item assets\* $dataDir -Recurse
          Copy-Item "src\build\windows\LICENSE.rtf" "$pioneerRoot\LICENSE.rtf"
          $artifactDir = "$pioneerRoot\share\julia\artifacts"
          if (Test-Path $artifactDir) {
            Get-ChildItem -Path $artifactDir -Recurse -Directory |
              Where-Object {
                $_.FullName -like "*QtQuick*" -or
                $_.FullName -like "*Qt6*"     -or
                $_.Name -eq "include"         -or
                $_.Name -eq "test"            -or
                $_.Name -eq ".qt"             -or
                $_.FullName.Length -gt 200
              } |
              Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
          }
          $info = Get-Content src\build\package_info.json | ConvertFrom-Json
          $desc       = $info.description
          $identifier = $info.identifier

          & heat.exe dir $pioneerRoot `
            -cg ProductComponents `
            -dr INSTALLFOLDER `
            -platform x64 `
            -gg -scom -sreg -sfrag -srd `
            -var var.SourceDir `
            -out components.wxs

          & candle.exe `
            -dSourceDir="$pioneerRoot" `
            -dProductVersion="${{ steps.get_version.outputs.VERSION }}" `
            -dProductDescription="$desc" `
            -dPackageIdentifier="$identifier" `
            -dPlatform="x64" `
            -arch x64 `
            -ext WixUIExtension `
            -ext WixUtilExtension `
            src\build\windows\installer.wxs components.wxs

          & light.exe `
            -ext WixUIExtension `
            -ext WixUtilExtension `
            -cultures:en-us `
            -out "Pioneer-${{ steps.get_version.outputs.VERSION }}-${{ matrix.identifier }}.msi" `
            installer.wixobj components.wixobj

      - name: Package zipped binaries
        shell: pwsh
        run: |
          $pioneerRoot = "build\Pioneer_${{ matrix.identifier }}\Applications\Pioneer"
          Compress-Archive -Path "$pioneerRoot\*" `
                           -DestinationPath "Pioneer-${{ steps.get_version.outputs.VERSION }}-${{ matrix.identifier }}.zip"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Pioneer-${{ matrix.identifier }}
          path: |
            Pioneer-${{ steps.get_version.outputs.VERSION }}-${{ matrix.identifier }}.msi
            Pioneer-${{ steps.get_version.outputs.VERSION }}-${{ matrix.identifier }}.zip

  release:
    name: Publish GitHub Release
    needs: build
    runs-on: ubuntu-latest
    if: >
      needs.build.outputs.version != '0.0.0' && (
        (github.event_name == 'push'       && startsWith(github.ref, 'refs/tags/')) ||
        (github.event_name == 'workflow_dispatch' && github.event.inputs.tag != '')
      )
    permissions:
      contents: write
      actions:  read

    steps:
      - name: Publish Release
        uses: ./.github/actions/publish-release
        with:
          version: ${{ needs.build.outputs.version }}
