name: Build & Release macOS

on:
  push:
    branches:
      - main
      - develop
    tags:
      - 'v*.*.*'
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v1.2.3)'
        required: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  build:
    name: Build & Package macOS
    runs-on: ${{ matrix.runner }}
    env:
      JULIA_NUM_THREADS: auto
    outputs:
      version: ${{ steps.get_version.outputs.VERSION }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64
            runner: macos-13
            identifier: macos-x64
          - arch: arm64
            runner: macos-latest
            identifier: macos-arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine VERSION
        id: get_version
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ github.event.inputs.tag }}" ]]; then
            echo "VERSION=${{ github.event.inputs.tag }}" >> "$GITHUB_OUTPUT"
          elif [[ "$GITHUB_REF" == refs/tags/* ]]; then
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"
          else
            echo "VERSION=0.0.0" >> "$GITHUB_OUTPUT"
          fi

      - name: Setup Julia
        uses: julia-actions/setup-julia@v2
        with:
          version: '1.11'
          arch: ${{ matrix.arch }}

      - name: Cache Julia packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.julia/registries
            ~/.julia/packages
          key: julia-macos-${{ matrix.identifier }}-${{ hashFiles('**/Project.toml','**/Manifest.toml') }}
          restore-keys: julia-macos-${{ matrix.identifier }}-

      - name: Install Apple certificate & provisioning profile
        env:
          BUILD_CERTIFICATE_BASE64:       ${{ secrets.MACOS_CERT_P12 }}
          P12_PASSWORD:                   ${{ secrets.MACOS_CERT_PASSWORD }}
          INSTALLER_CERT_BASE64:          ${{ secrets.MACOS_INSTALLER_CERT_P12 }}
          INSTALLER_CERT_PASSWORD:        ${{ secrets.MACOS_CERT_PASSWORD }}
          BUILD_PROVISION_PROFILE_BASE64: ${{ secrets.BUILD_PROVISION_PROFILE_BASE64 }}
          KEYCHAIN_PASSWORD:              ${{ secrets.MACOS_CERT_PASSWORD }}
        run: |
          CERT_PATH=$RUNNER_TEMP/build_cert.p12
          INSTALLER_PATH=$RUNNER_TEMP/installer_cert.p12
          PP_PATH=$RUNNER_TEMP/provision.mobileprovision
          KEYCHAIN=$RUNNER_TEMP/signing.keychain-db

          echo -n "$BUILD_CERTIFICATE_BASE64"    | base64 --decode > "$CERT_PATH"
          echo -n "$INSTALLER_CERT_BASE64"       | base64 --decode > "$INSTALLER_PATH"
          echo -n "$BUILD_PROVISION_PROFILE_BASE64" | base64 --decode > "$PP_PATH"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN"
          security set-keychain-settings -lut 21600 "$KEYCHAIN"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN"

          security import "$CERT_PATH"        -k "$KEYCHAIN" -P "$P12_PASSWORD"         -T /usr/bin/codesign
          security import "$INSTALLER_PATH"   -k "$KEYCHAIN" -P "$INSTALLER_CERT_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN"

          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp "$PP_PATH" ~/Library/MobileDevice/Provisioning\ Profiles/

      - uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64:   ${{ secrets.MACOS_CERT_P12 }}
          p12-password:      ${{ secrets.MACOS_CERT_PASSWORD }}
          keychain-password: ${{ secrets.MACOS_CERT_PASSWORD }}
          keychain:          signing_temp

      - uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64:   ${{ secrets.MACOS_INSTALLER_CERT_P12 }}
          p12-password:      ${{ secrets.MACOS_CERT_PASSWORD }}
          keychain-password: ${{ secrets.MACOS_CERT_PASSWORD }}
          keychain:          signing_temp
          create-keychain:   false

      - name: Install dependencies
        run: |
          julia --project=. -e 'using Pkg; Pkg.add("PackageCompiler"); Pkg.instantiate()'

      - name: Precompile data (cache & download)
        uses: ./.github/actions/precompile-data
        with:
          cache-key: precompile-data-v1

      - name: Compile application
        run: |
          julia --project=. -e '
            using PackageCompiler;
            create_app(
              ".",
              "build/Pioneer_${{ matrix.identifier }}/Applications/Pioneer/",
              incremental=false,
              force=true,
              executables=[
                "GetSearchParams"=>"main_GetSearchParams",
                "GetBuildLibParams"=>"main_GetBuildLibParams",
                "GetParseSpecLibParams"=>"main_GetParseSpecLibParams",
                "ParseSpecLib"=>"main_ParseSpecLib",
                "BuildSpecLib"=>"main_BuildSpecLib",
                "SearchDIA"=>"main_SearchDIA",
                "convertMzML"=>"main_convertMzML"
              ],
              precompile_execution_file="src/build/snoop.jl"
            );
          '

      - name: Download PioneerConverter
        shell: bash
        run: |
          mkdir -p converter
          if [[ "${{ matrix.identifier }}" == "macos-x64" ]]; then
            PATTERN="osx-x64"
          else
            PATTERN="osx-arm64"
          fi
          ASSET=$(curl -sL https://api.github.com/repos/nwamsley1/PioneerConverter/releases/latest \
            | jq -r --arg PATTERN "$PATTERN" '.assets[]
              | select(.name | test("PioneerConverter-"+$PATTERN+".*\\.zip"))
              | .name' | head -n1)
          curl -L "https://github.com/nwamsley1/PioneerConverter/releases/latest/download/$ASSET" \
            -o converter.zip
          unzip -q converter.zip -d converter
          cp -r "converter/PioneerConverter-${PATTERN}/bin/"* \
            "build/Pioneer_${{ matrix.identifier }}/Applications/Pioneer/bin/"
          mkdir -p "build/Pioneer_${{ matrix.identifier }}/Applications/Pioneer/lib"
          cp -r "converter/PioneerConverter-${PATTERN}/lib/"* \
            "build/Pioneer_${{ matrix.identifier }}/Applications/Pioneer/lib/"

      - name: Prune unneeded files
        uses: ./.github/actions/prune
        with:
          app_root: build/Pioneer_${{ matrix.identifier }}/Applications/Pioneer

      - name: Add wrapper scripts
        run: |
          cp src/build/CLI/pioneer \
            build/Pioneer_${{ matrix.identifier }}/Applications/Pioneer/
          chmod +x build/Pioneer_${{ matrix.identifier }}/Applications/Pioneer/pioneer

      - name: Codesign & package macOS app
        env:
          CODESIGN_IDENTITY: ${{ secrets.CODESIGN_IDENTITY }}
          PKG_SIGN_IDENTITY:  ${{ secrets.PKG_SIGN_IDENTITY }}
        run: |
          APP="Pioneer"
          DIST="build/Pioneer_${{ matrix.identifier }}/Applications/Pioneer"
          PKGROOT="pkgroot"
          VERSION=${{ steps.get_version.outputs.VERSION }}

          rm -rf "$PKGROOT"
          mkdir -p "$PKGROOT/usr/local/$APP"
          cp -R "$DIST"/* "$PKGROOT/usr/local/$APP/"
          mkdir -p "$PKGROOT/usr/local/$APP/data"
          cp -R assets/* "$PKGROOT/usr/local/$APP/data/"
          chmod -R a+w "$PKGROOT/usr/local/$APP/share/julia"

          find "$PKGROOT/usr/local/$APP" -type f -print0 \
            | xargs -0 -n1 codesign --deep --force --options runtime \
                --timestamp --entitlements src/build/osx/entitlements.plist \
                --sign "$CODESIGN_IDENTITY"

          mkdir -p "$PKGROOT/usr/local/bin"
          ln -sf /usr/local/Pioneer/pioneer "$PKGROOT/usr/local/bin/pioneer"

          IDENTIFIER=$(jq -r '.identifier' src/build/package_info.json)

          pkgbuild --root "$PKGROOT" \
                   --identifier "$IDENTIFIER" \
                   --version "$VERSION" \
                   --install-location / PioneerUnsigned.pkg

          productsign --sign "$PKG_SIGN_IDENTITY" \
                      PioneerUnsigned.pkg \
                      Pioneer-${{ steps.get_version.outputs.VERSION }}-${{ matrix.identifier }}.pkg

          rm PioneerUnsigned.pkg

      - name: Notarize macOS package
        env:
          AC_USERNAME: ${{ secrets.NOTARIZE_APPLE_ID }}
          AC_PASSWORD: ${{ secrets.NOTARIZE_PASSWORD }}
          TEAM_ID:    ${{ secrets.NOTARIZE_TEAM_ID }}
        run: |
          xcrun notarytool store-credentials notary-profile \
            --apple-id "$AC_USERNAME" --team-id "$TEAM_ID" \
            --password "$AC_PASSWORD"
          result=$(xcrun notarytool submit \
                     Pioneer-${{ steps.get_version.outputs.VERSION }}-${{ matrix.identifier }}.pkg \
                     --keychain-profile notary-profile \
                     --wait --output-format json)
          status=$(echo "$result" | jq -r .status)
          subid=$(echo "$result" | jq -r .id)
          if [[ "$status" != "Accepted" ]]; then
            echo "Notarization failed: $status"
            xcrun notarytool log "$subid" --keychain-profile notary-profile
            exit 1
          fi

      - name: Staple notarization ticket
        run: |
          xcrun stapler staple \
            Pioneer-${{ steps.get_version.outputs.VERSION }}-${{ matrix.identifier }}.pkg

      - name: Package zipped binaries
        run: |
          cd build/Pioneer_${{ matrix.identifier }}/Applications
          zip -qr ../../../Pioneer-${{ steps.get_version.outputs.VERSION }}-${{ matrix.identifier }}.zip Pioneer

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Pioneer-${{ matrix.identifier }}
          path: |
            Pioneer-${{ steps.get_version.outputs.VERSION }}-${{ matrix.identifier }}.pkg
            Pioneer-${{ steps.get_version.outputs.VERSION }}-${{ matrix.identifier }}.zip

  release:
    name: Publish GitHub Release
    needs: build
    runs-on: ubuntu-latest
    if: >
      needs.build.outputs.version != '0.0.0' && (
        (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')) ||
        (github.event_name == 'workflow_dispatch' && github.event.inputs.tag != '')
      )
    permissions:
      contents: write
      actions: read
    env:
      VERSION:      ${{ needs.build.outputs.version }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup GitHub CLI
        uses: actions/setup-gh@v3

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create or update Release
        run: |
          gh release view "${VERSION}" \
            || gh release create "${VERSION}" \
                 --title "Release ${VERSION}" \
                 --notes "Automated release for ${VERSION}"

      - name: Upload all assets
        run: |
          for file in artifacts/**/*; do
            gh release upload "${VERSION}" "$file" \
              --clobber --name "$(basename "$file")"
          done

      - name: Notify success
        run: echo "âœ… Published version ${VERSION}"
